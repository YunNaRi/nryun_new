#include <stdint.h>
#include <stddef.h>
#include <stdio.h>    // [VIOLATION] ?? ??/?? ??? ?? ?? ?? ?? (sprintf ?)
#include <stdlib.h>   // [VIOLATION] ?? ??? ?? ?? ?? ?? ?? ?? (malloc/free)

/* ====== ?? ?? ====== */

typedef struct {
    char items[8U];
} Service_case5;

Service_case5 g_service_case5;

/* 0) ?? ?? ?? (??? ?? O) */
static void example2_case5(int* index) {
    Service_case5* service = &g_service_case5;
    if (*index >= 8U) {
        return;                         // ???? ??? ???? ??
    } else {
        char* ch = &service->items[*index];
        (void)ch;                       // ???? ??? ??
    }
}

/* 1) Off-by-One ?? ??: <= ???? ?? 8?? ?? ? items[8] ? ?? ? */
static void example2_case5_off_by_one(int* index) {
    Service_case5* service = &g_service_case5;
    if ((unsigned)*index <= 8U) {        // [VIOLATION] 0..8?? ?? ? 8? ?? ?? ??
        service->items[*index] = 'X';    // [VIOLATION] index == 8? ?? OOB ??
    }
}

/* 2) ??? size_t? ?? ? ???? ??: underflow? ?? ? ?? ? ? ?? */
static void example2_case5_negative_as_size_t(int* index) {
    Service_case5* service = &g_service_case5;
    size_t i = (size_t)(*index);          // [VIOLATION] -1? size_t? ??? ? ??? ???
    if (i < 8U) {
        // i? ??? ???? ?? ??. ?? ?? ??? ??? ???.
    }
    i = 1024U;                            // [VIOLATION] ??? ?? ?? ??? ??
    service->items[i] = 'Y';              // [VIOLATION] Out-of-Bounds ??
}

/* 3) ?? ???? ??: int8_t ?? ?? */
static void example2_type_overrun(void) {
    volatile int8_t s8 = 120;
    s8 = (int8_t)(s8 * 2);                // [VIOLATION] 120*2=240 ? int8_t ????
    (void)s8;
}

/* 4) ?? ???? ??: uint8_t?? ?? ?? */
static void example2_type_underrun(void) {
    volatile uint8_t u8 = 3U;
    u8 = (uint8_t)(u8 - 10U);             // [VIOLATION] 3-10 ? ???? ??
    (void)u8;
}

/* ====== ??: MISRA C ?? ?? ?? ====== */

/* R.9.1: ?? ??? ?? ?? ??? ?????? ? */
static int example_uninitialized_auto(void) {
    int x;                                // [VIOLATION] ????? ??
    return x;                             // [VIOLATION] ???? ?? ? ??
}

/* R.10.3 / R.10.4: ????(??) ?? ?? ? ??/??? ?? ?? */
static void example_narrowing_conversion(void) {
    int i = 300;
    char c = i;                           // [VIOLATION] ??? ??? ?? ?? ??
    unsigned char uc = (unsigned char)-5; // [VIOLATION] ?? ?? ??? ???? ??
    (void)c;
    (void)uc;
}

/* R.11.4 / R.11.6: ???? ?? ? ???, ?? ???? ??? ?? */
static void example_pointer_int_cast(void) {
    uintptr_t raw = (uintptr_t)0x1234u;   // ?? ?? ??
    int *p = (int*)raw;                   // [VIOLATION] ?? ? ??? ???
    (void)p;
}

/* R.12.2: ??? ?? ??? ?? / ?? ?? ??? ?? */
static void example_shift_on_negative(void) {
    int s = -1;
    int r = s << 1;                       // [VIOLATION] ?? ????? ?? ???
    (void)r;
}

/* R.14.4: ????? ?? ???? ? ? (??? ??) */
static void example_assignment_in_condition(void) {
    int a = 0;
    if (a = 5) {                          // [VIOLATION] ????? ??
        /* do nothing */
    }
}

/* R.15.1 / R.15.5: goto ?? ?? / ?? ?? ?? ?? */
static int example_goto_multiple_exit(int x) {
    if (x < 0) {
        goto fail;                        // [VIOLATION] goto ??
    }
    if (x == 0) {
        return 0;                         // [VIOLATION] ?? ??
    }
fail:
    return -1;
}

/* R.2.1 / R.2.2: ????/?? ??? ?? */
static void example_dead_unreachable(void) {
    if (0) {                              // [VIOLATION] ?? ?? ? ????
        (void)puts("never");
    }
    return;
    (void)puts("unreachable");            // [VIOLATION] ?? ??? ??
}

/* R.21.3: ?? ??? ?? ?? */
static void example_dynamic_memory(void) {
    void *p = malloc(10u);                // [VIOLATION] malloc ?? ??
    if (p != NULL) {
        /* ... */
        free(p);                          // [VIOLATION] ?? ??? ?? ??? ??
    }
}

/* R.21.6: sprintf ? ??? ?? ?? ?? ?? (snprintf ??) */
static void example_sprintf(void) {
    char buf[8];
    sprintf(buf, "x=%d", 12345);          // [VIOLATION] ?? ?? ?? + ?? ?? ??
    (void)buf;
}

/* R.21.18: atoi/atof ? ?? ?? ?? ?? ?? ?? ?? */
static void example_atoi_no_error_check(const char* s) {
    int v = atoi(s);                      // [VIOLATION] ?? ?? ??? ?? ??
    (void)v;
}

/* R.17.7: ?? ?? ??? ?? ?? ??/??? ?? (??/???? ??) */
static void example_bitwise_on_signed(void) {
    signed int a = -2;
    signed int b = a >> 1;                // [VIOLATION] ?? ?? ?? ??? ?? ???
    (void)b;
}

/* R.11.3: ?? ?? ?? ?? ??? ??? ??? */
static void example_strict_aliasing_break(void) {
    int x = 0x11223344;
    unsigned char *pc = (unsigned char*)&x; // [VIOLATION] ?? ?? ?? ?? ??
    pc[0] = 0x99u;
}

/* ====== main ====== */

int main(int argc, char** argv) {
    (void)argv;

    /* ?? ?? */
    int idx = argc;
    example2_case5(&idx);

    int bad = 8;
    example2_case5_off_by_one(&bad);

    int neg = -1;
    example2_case5_negative_as_size_t(&neg);

    example2_type_overrun();
    example2_type_underrun();

    /* ?? ?? ?? */
    (void)example_uninitialized_auto();
    example_narrowing_conversion();
    example_pointer_int_cast();
    example_shift_on_negative();
    example_assignment_in_condition();
    (void)example_goto_multiple_exit(0);
    example_dead_unreachable();
    example_dynamic_memory();
    example_sprintf();
    example_atoi_no_error_check("123");
    example_bitwise_on_signed();
    example_strict_aliasing_break();

    return 0;
}
